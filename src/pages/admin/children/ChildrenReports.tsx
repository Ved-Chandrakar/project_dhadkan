import { useState, useEffect } from 'react'
import { User } from '../../../App'
import './ChildrenReports.css'

interface ChildrenReportsProps {
  user: User
  onBack: () => void
}

interface ChildReport {
  id: number
  dr_id: number
  name: string
  gender: 'рдкреБрд░реБрд╖' | 'рдорд╣рд┐рд▓рд╛'
  fatherName: string
  mobileNo: string
  schoolName: string
  haveAadhar: 'yes' | 'no'
  haveShramik: 'yes' | 'no'
  aadharPhoto: string | null
  shramikPhoto: string | null
  heartStatus: 'рд╕рдВрджрд┐рдЧреНрдз' | 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ'
  notes: string | null
  // Legacy fields for compatibility
  childName: string
  motherName: string
  age: number
  mobileNumber: string
  address: string
  aadharAvailable: boolean
  shramikCardAvailable: boolean
  symptoms: string[]
  diseaseFound: boolean
  screeningDate: string
  doctorName: string
  weight: number
  height: number
  heartRate: number
  bloodPressure: string
  healthStatus: 'рд╕реНрд╡рд╕реНрде' | 'рдЕрд╕рд╛рдорд╛рдиреНрдп' | 'рдЬрд╛рдВрдЪ рдореЗрдВ'
}

const ChildrenReports = ({ user, onBack }: ChildrenReportsProps) => {
  const [searchTerm, setSearchTerm] = useState('')
  const [filterStatus, setFilterStatus] = useState('')
  const [filterDoctor, setFilterDoctor] = useState('')
  const [selectedChild, setSelectedChild] = useState<ChildReport | null>(null)
  const [currentPage, setCurrentPage] = useState(1)
  const itemsPerPage = 10

  // ESC key functionality for going back
  useEffect(() => {
    const handleKeyPress = (event: KeyboardEvent) => {
      if (event.key === 'Escape' && !selectedChild) {
        onBack()
      }
    }
    
    window.addEventListener('keydown', handleKeyPress)
    return () => window.removeEventListener('keydown', handleKeyPress)
  }, [onBack, selectedChild])

  const mockReports: ChildReport[] = [
    {
      id: 1,
      dr_id: 1,
      name: 'рд░рд╛рд╣реБрд▓ рдХреБрдорд╛рд░',
      gender: 'рдкреБрд░реБрд╖',
      fatherName: 'рд╕реБрдиреАрд▓ рдХреБрдорд╛рд░',
      mobileNo: '9876543210',
      schoolName: 'рд╕рд░рдХрд╛рд░реА рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рджреНрдпрд╛рд▓рдп',
      haveAadhar: 'yes',
      haveShramik: 'no',
      aadharPhoto: 'path/to/aadhar1.jpg',
      shramikPhoto: null,
      heartStatus: 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ',
      notes: 'рд╕рд╛рдорд╛рдиреНрдп рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕реНрдерд┐рддрд┐',
      // Legacy fields for compatibility
      childName: 'рд░рд╛рд╣реБрд▓ рдХреБрдорд╛рд░',
      motherName: 'рд╕реБрдиреАрддрд╛ рдХреБрдорд╛рд░',
      age: 8,
      mobileNumber: '9876543210',
      address: 'рд╕реЗрдХреНрдЯрд░ 15, рдЧреБрдбрд╝рдЧрд╛рдВрд╡, рд╣рд░рд┐рдпрд╛рдгрд╛',
      aadharAvailable: true,
      shramikCardAvailable: false,
      symptoms: ['рд╕рд╛рдорд╛рдиреНрдп рдЦрд╛рдВрд╕реА', 'рд╣рд▓реНрдХрд╛ рдмреБрдЦрд╛рд░'],
      diseaseFound: false,
      screeningDate: '2025-01-29',
      doctorName: 'рдбреЙ. рдкреНрд░рд┐рдпрд╛ рд╢рд░реНрдорд╛',
      weight: 25,
      height: 120,
      heartRate: 85,
      bloodPressure: '110/70',
      healthStatus: 'рд╕реНрд╡рд╕реНрде'
    },
    {
      id: 2,
      dr_id: 2,
      name: 'рдЖрд░рддреА рджреЗрд╡реА',
      gender: 'рдорд╣рд┐рд▓рд╛',
      fatherName: 'рд░рд╛рдЬ рдХреБрдорд╛рд░',
      mobileNo: '9876543211',
      schoolName: 'рджрд┐рд▓реНрд▓реА рдкрдмреНрд▓рд┐рдХ рд╕реНрдХреВрд▓',
      haveAadhar: 'yes',
      haveShramik: 'yes',
      aadharPhoto: 'path/to/aadhar2.jpg',
      shramikPhoto: 'path/to/shramik2.jpg',
      heartStatus: 'рд╕рдВрджрд┐рдЧреНрдз',
      notes: 'рд╣реГрджрдп рдХреА рдЬрд╛рдВрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛',
      // Legacy fields for compatibility
      childName: 'рдЖрд░рддреА рджреЗрд╡реА',
      motherName: 'рд╕рд░рд┐рддрд╛ рджреЗрд╡реА',
      age: 6,
      mobileNumber: '9876543211',
      address: 'рдореЙрдбрд▓ рдЯрд╛рдЙрди, рджрд┐рд▓реНрд▓реА',
      aadharAvailable: true,
      shramikCardAvailable: true,
      symptoms: ['рд╕рд╛рдВрд╕ рд▓реЗрдиреЗ рдореЗрдВ рдХрдард┐рдирд╛рдИ', 'рд╕реАрдиреЗ рдореЗрдВ рджрд░реНрдж'],
      diseaseFound: true,
      screeningDate: '2025-01-29',
      doctorName: 'рдбреЙ. рдЕрдорд┐рдд рд╡рд░реНрдорд╛',
      weight: 18,
      height: 105,
      heartRate: 95,
      bloodPressure: '120/80',
      healthStatus: 'рдЕрд╕рд╛рдорд╛рдиреНрдп'
    },
    {
      id: 3,
      dr_id: 3,
      name: 'рд╡рд┐рдХрд╛рд╕ рд╢рд░реНрдорд╛',
      gender: 'рдкреБрд░реБрд╖',
      fatherName: 'рдореЛрд╣рди рд╢рд░реНрдорд╛',
      mobileNo: '9876543212',
      schoolName: 'рдХреЗрдВрджреНрд░реАрдп рд╡рд┐рджреНрдпрд╛рд▓рдп',
      haveAadhar: 'yes',
      haveShramik: 'no',
      aadharPhoto: 'path/to/aadhar3.jpg',
      shramikPhoto: null,
      heartStatus: 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ',
      notes: 'рдкреВрд░реНрдг рд╕реНрд╡рд╕реНрде',
      // Legacy fields for compatibility
      childName: 'рд╡рд┐рдХрд╛рд╕ рд╢рд░реНрдорд╛',
      motherName: 'рдЧреАрддрд╛ рд╢рд░реНрдорд╛',
      age: 7,
      mobileNumber: '9876543212',
      address: 'рд▓рд╛рдЬрдкрдд рдирдЧрд░, рдирдИ рджрд┐рд▓реНрд▓реА',
      aadharAvailable: true,
      shramikCardAvailable: false,
      symptoms: [],
      diseaseFound: false,
      screeningDate: '2025-01-28',
      doctorName: 'рдбреЙ. рд╕реБрдиреАрддрд╛ рдЧреБрдкреНрддрд╛',
      weight: 22,
      height: 115,
      heartRate: 80,
      bloodPressure: '100/65',
      healthStatus: 'рд╕реНрд╡рд╕реНрде'
    },
    {
      id: 4,
      dr_id: 4,
      name: 'рдЕрдирд┐рддрд╛ рдХреБрдорд╛рд░реА',
      gender: 'рдорд╣рд┐рд▓рд╛',
      fatherName: 'рд░рдореЗрд╢ рдкреНрд░рд╕рд╛рдж',
      mobileNo: '9876543213',
      schoolName: 'рд╕рд░рдХрд╛рд░реА рдХрдиреНрдпрд╛ рд╡рд┐рджреНрдпрд╛рд▓рдп',
      haveAadhar: 'no',
      haveShramik: 'yes',
      aadharPhoto: null,
      shramikPhoto: 'path/to/shramik4.jpg',
      heartStatus: 'рд╕рдВрджрд┐рдЧреНрдз',
      notes: 'рдкреЗрдЯ рд╕рдВрдмрдВрдзреА рд╕рдорд╕реНрдпрд╛',
      // Legacy fields for compatibility
      childName: 'рдЕрдирд┐рддрд╛ рдХреБрдорд╛рд░реА',
      motherName: 'рд╢рд╛рдВрддрд┐ рджреЗрд╡реА',
      age: 9,
      mobileNumber: '9876543213',
      address: 'рд╕рджрд░ рдмрд╛рдЬрд╛рд░, рджрд┐рд▓реНрд▓реА',
      aadharAvailable: false,
      shramikCardAvailable: true,
      symptoms: ['рдкреЗрдЯ рджрд░реНрдж', 'рднреВрдЦ рди рд▓рдЧрдирд╛'],
      diseaseFound: true,
      screeningDate: '2025-01-27',
      doctorName: 'рдбреЙ. рд░рд╛рдЬреЗрд╢ рдХреБрдорд╛рд░',
      weight: 28,
      height: 125,
      heartRate: 88,
      bloodPressure: '105/68',
      healthStatus: 'рдЬрд╛рдВрдЪ рдореЗрдВ'
    }
  ]

  const doctors = Array.from(new Set(mockReports.map(report => report.doctorName)))
  const healthStatuses = ['рд╕реНрд╡рд╕реНрде', 'рдЕрд╕рд╛рдорд╛рдиреНрдп', 'рдЬрд╛рдВрдЪ рдореЗрдВ']

  const filteredReports = mockReports.filter(report => {
    const matchesSearch = report.childName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         report.fatherName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         report.schoolName.toLowerCase().includes(searchTerm.toLowerCase())
    const matchesStatus = !filterStatus || report.healthStatus === filterStatus
    const matchesDoctor = !filterDoctor || report.doctorName === filterDoctor
    return matchesSearch && matchesStatus && matchesDoctor
  })

  const totalPages = Math.ceil(filteredReports.length / itemsPerPage)
  const startIndex = (currentPage - 1) * itemsPerPage
  const paginatedReports = filteredReports.slice(startIndex, startIndex + itemsPerPage)

  const normalCount = mockReports.filter(r => r.heartStatus === 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ').length
  const suspiciousCount = mockReports.filter(r => r.heartStatus === 'рд╕рдВрджрд┐рдЧреНрдз').length
  const totalCount = mockReports.length

  const handleViewDetails = (report: ChildReport) => {
    setSelectedChild(report)
  }

  const handleExportReport = () => {
    // Export functionality would be implemented here
    alert('рд░рд┐рдкреЛрд░реНрдЯ рдПрдХреНрд╕рдкреЛрд░реНрдЯ рд╣реЛ рд░рд╣реА рд╣реИ...')
  }

  return (
    <div className="children-reports">
      <div className="page-header">
        <div className="header-content">
          <div>
            <h1>рдмрдЪреНрдЪреЛрдВ рдХреА рд░рд┐рдкреЛрд░реНрдЯ</h1>
            <p>рд╕рднреА рдмрдЪреНрдЪреЛрдВ рдХреА рд╕реНрд╡рд╛рд╕реНрдереНрдп рдЬрд╛рдВрдЪ рд░рд┐рдкреЛрд░реНрдЯ рдФрд░ рд╡рд┐рд╡рд░рдг - {user.name}</p>
          </div>
        </div>
      </div>

      <div className="content-container">
        {/* Stats Cards */}
        <div className="stats-row">
          <div className="stat-card healthy">
            <h3>рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓реЗ</h3>
            <p className="stat-number">{normalCount}</p>
            <span className="stat-icon">тЬЕ</span>
          </div>
          <div className="stat-card unhealthy">
            <h3>рд╕рдВрджрд┐рдЧреНрдз рдорд╛рдорд▓реЗ</h3>
            <p className="stat-number">{suspiciousCount}</p>
            <span className="stat-icon">тЪая╕П</span>
          </div>
          {/* <div className="stat-card pending">
            <h3>рдЬрд╛рдВрдЪ рдореЗрдВ</h3>
            <p className="stat-number">{pendingCount}</p>
            <span className="stat-icon">ЁЯФН</span>
          </div> */}
          <div className="stat-card total">
            <h3>рдХреБрд▓ рдмрдЪреНрдЪреЗ</h3>
            <p className="stat-number">{totalCount}</p>
            <span className="stat-icon">ЁЯС╢</span>
          </div>
        </div>

        {/* Search and Filter */}
        <div className="search-filter-section">
          <div className="search-box">
            <input
              type="text"
              placeholder="рдмрдЪреНрдЪреЗ рдХрд╛ рдирд╛рдо, рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо рдпрд╛ рд╕реНрдХреВрд▓ рдЦреЛрдЬреЗрдВ..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <span className="search-icon">ЁЯФН</span>
          </div>
          
          <div className="filter-section">
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
            >
              <option value="">рд╕рднреА рд╕реНрдерд┐рддрд┐рдпрд╛рдВ</option>
              {healthStatuses.map(status => (
                <option key={status} value={status}>{status}</option>
              ))}
            </select>

            <select
              value={filterDoctor}
              onChange={(e) => setFilterDoctor(e.target.value)}
            >
              <option value="">рд╕рднреА рдЪрд┐рдХрд┐рддреНрд╕рдХ</option>
              {doctors.map(doctor => (
                <option key={doctor} value={doctor}>{doctor}</option>
              ))}
            </select>
          </div>

          {/* <button className="btn-primary" onClick={handleExportReport}>
            рд░рд┐рдкреЛрд░реНрдЯ рдПрдХреНрд╕рдкреЛрд░реНрдЯ рдХрд░реЗрдВ
          </button> */}
        </div>

        {/* Reports Table */}
        <div className="table-container">
          <table className="reports-table">
            <thead>
              <tr>
                <th>рдмрдЪреНрдЪреЗ рдХрд╛ рд╡рд┐рд╡рд░рдг</th>
                <th>рдкрд┐рддрд╛</th>
                <th>рд╕реНрдХреВрд▓</th>
                <th>рдЬрд╛рдВрдЪ рдХреА рддрд╛рд░реАрдЦ</th>
                <th>рдЪрд┐рдХрд┐рддреНрд╕рдХ</th>
                <th>рд╣реГрджрдп рд╕реНрдерд┐рддрд┐</th>
                <th>рдХрд╛рд░реНрд░рд╡рд╛рдИ</th>
              </tr>
            </thead>
            <tbody>
              {paginatedReports.map(report => (
                <tr key={report.id}>
                  <td>
                    <div className="child-info">
                      <div className="child-avatar">
                        {report.gender === 'рдкреБрд░реБрд╖' ? 'ЁЯСж' : 'ЁЯСз'}
                      </div>
                      <div>
                        <div className="child-name">{report.childName}</div>
                        <div className="child-details">
                          {report.age} рд╡рд░реНрд╖, {report.gender}
                        </div>
                        <div className="child-contact">{report.mobileNumber}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div className="parent-info">
                      <div>рдкрд┐рддрд╛: {report.fatherName}</div>
                      {/* <div>рдорд╛рддрд╛: {report.motherName}</div> */}
                    </div>
                  </td>
                  <td>{report.schoolName}</td>
                  <td>{report.screeningDate}</td>
                  <td>рдбреЙрдХреНрдЯрд░ ID: {report.dr_id}</td>
                  <td>
                    <span className={`status-badge status-${report.heartStatus === 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ' ? 'healthy' : 'suspicious'}`}>
                      {report.heartStatus}
                    </span>
                  </td>
                  <td>
                    <div className="action-buttons">
                      <button 
                        className="btn-small btn-primary"
                        onClick={() => handleViewDetails(report)}
                      >
                        рд╡рд┐рд╕реНрддрд╛рд░ рджреЗрдЦреЗрдВ
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="pagination">
            <button 
              className="pagination-btn"
              onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
              disabled={currentPage === 1}
            >
              тЖР рдкрд┐рдЫрд▓рд╛
            </button>
            
            <div className="pagination-info">
              рдкреГрд╖реНрда {currentPage} / {totalPages}
            </div>
            
            <button 
              className="pagination-btn"
              onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
              disabled={currentPage === totalPages}
            >
              рдЕрдЧрд▓рд╛ тЖТ
            </button>
          </div>
        )}

        {filteredReports.length === 0 && (
          <div className="no-results">
            <p>рдХреЛрдИ рд░рд┐рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдорд┐рд▓реАред</p>
          </div>
        )}
      </div>

      {/* Child Detail Modal */}
      {selectedChild && (
        <div className="modal-overlay">
          <div className="modal-content large-modal">
            <div className="modal-header">
              <h3>рдмрдЪреНрдЪреЗ рдХреА рд╡рд┐рд╕реНрддреГрдд рд░рд┐рдкреЛрд░реНрдЯ</h3>
              <button className="close-btn" onClick={() => setSelectedChild(null)}>├Ч</button>
            </div>
            <div className="modal-body">
              <div className="child-detail-grid">
                <div className="detail-section">
                  <h4>рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЬрд╛рдирдХрд╛рд░реА</h4>
                  <div className="detail-row">
                    <span className="label">рдирд╛рдо:</span>
                    <span className="value">{selectedChild.name}</span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рд▓рд┐рдВрдЧ:</span>
                    <span className="value">{selectedChild.gender}</span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо:</span>
                    <span className="value">{selectedChild.fatherName}</span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</span>
                    <span className="value">{selectedChild.mobileNo}</span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рд╕реНрдХреВрд▓:</span>
                    <span className="value">{selectedChild.schoolName}</span>
                  </div>
                </div>

                <div className="detail-section">
                  <h4>рджрд╕реНрддрд╛рд╡реЗрдЬ рд╕реНрдерд┐рддрд┐</h4>
                  <div className="detail-row">
                    <span className="label">рдЖрдзрд╛рд░ рдХрд╛рд░реНрдб:</span>
                    <span className={`value ${selectedChild.haveAadhar === 'yes' ? 'available' : 'not-available'}`}>
                      {selectedChild.haveAadhar === 'yes' ? 'рд╣рд╛рдВ' : 'рдирд╣реАрдВ'}
                    </span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рд╢реНрд░рдорд┐рдХ рдХрд╛рд░реНрдб:</span>
                    <span className={`value ${selectedChild.haveShramik === 'yes' ? 'available' : 'not-available'}`}>
                      {selectedChild.haveShramik === 'yes' ? 'рд╣рд╛рдВ' : 'рдирд╣реАрдВ'}
                    </span>
                  </div>
                  {selectedChild.aadharPhoto && (
                    <div className="detail-row">
                      <span className="label">рдЖрдзрд╛рд░ рдлреЛрдЯреЛ:</span>
                      <span className="value">рдЙрдкрд▓рдмреНрдз</span>
                    </div>
                  )}
                  {selectedChild.shramikPhoto && (
                    <div className="detail-row">
                      <span className="label">рд╢реНрд░рдорд┐рдХ рдлреЛрдЯреЛ:</span>
                      <span className="value">рдЙрдкрд▓рдмреНрдз</span>
                    </div>
                  )}
                </div>

                <div className="detail-section">
                  <h4>рдЪрд┐рдХрд┐рддреНрд╕рд╛ рдЬрд╛рдирдХрд╛рд░реА</h4>
                  <div className="detail-row">
                    <span className="label">рдЪрд┐рдХрд┐рддреНрд╕рдХ ID:</span>
                    <span className="value">{selectedChild.dr_id}</span>
                  </div>
                  <div className="detail-row">
                    <span className="label">рд╣реГрджрдп рд╕реНрдерд┐рддрд┐:</span>
                    <span className={`value status-${selectedChild.heartStatus === 'рд╕рдВрджреЗрд╣ рдирд╣реАрдВ' ? 'healthy' : 'suspicious'}`}>
                      {selectedChild.heartStatus}
                    </span>
                  </div>
                  {selectedChild.notes && (
                    <div className="detail-row full-width">
                      <span className="label">рдЯрд┐рдкреНрдкрдгреА:</span>
                      <span className="value">{selectedChild.notes}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn-secondary" onClick={() => setSelectedChild(null)}>
                рдмрдВрдж рдХрд░реЗрдВ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default ChildrenReports
